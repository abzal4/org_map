<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Карта с таблицей в углу</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; font-size: 12px; }
    #map { height: 100vh; width: 100%; }
    .table-container {
      background: rgba(255, 255, 255, 0.425);
      backdrop-filter: blur(4px);
      border: 1px solid #ccc; border-radius: 8px;
      padding: 10px; overflow: auto;
      resize: vertical; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000; width: 600px; height: 400px;
    }
    .table-container.collapsed { height: 110px; }
    .table-container.collapsed table,
    .table-container input, .table-container button {
      width: 100%; margin-bottom: 8px; padding: 5px;
      border-radius: 4px; border: 1px solid #ccc;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td {
      padding: 6px 8px; border: 1px solid #ddd; text-align: left;
    }
    th { background-color: #f0f0f0; position: sticky; top: 0; z-index: 1; }
    tr:hover { background-color: rgba(200, 200, 255, 0.3); cursor: pointer; }
    .subcell {
      display: none; padding: 0;
      background: rgba(255,255,255,0.225);
      backdrop-filter: blur(4px); border: 1px solid #ddd;
      border-top: none; font-size: 12px;
      max-height: 150px; overflow-y: auto;
    }
    .subitem {
      padding: 6px; border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }
    .subitem:hover { background-color: rgba(200, 200, 255, 0.2); }

    .side-panel {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      max-width: 600px;
    }

    #region-info {
      margin-top: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 13px;
    }

  </style>
</head>
<body>

<div id="map"></div>
<div class="side-panel">
<div class="table-container collapsed">
  <input type="text" id="search-input" placeholder="Сопровождающий, организация или БИН">
  <button id="reset-view">Показать всех</button>
  <button id="toggle-table">Развернуть таблицу</button>
  <table>
    <thead>
      <tr>
        <th>Сопровождающий</th>
        <th>Кол-во организаций</th>
        <th>Подключено к ЕХД БО</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
</div>
<div id="region-info">Нажмите на регион для просмотра статистики</div>
</div>


<script>
  const map = L.map('map', {
    center: [47.5, 68.5],
    zoom: 5.4,
    minZoom: 5,
    maxZoom: 19,
    maxBounds: [[30.0, 42.0], [59.0, 95.0]],
    maxBoundsViscosity: 2.0
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const regionNameMap = {
    "Abai": "АБАЙСКАЯ ОБЛ.",
    "Akmola": "АКМОЛИНСКАЯ ОБЛ.",
    "Aktobe": "АКТЮБИНСКАЯ ОБЛ.",
    "Almaty": "АЛМАТИНСКАЯ ОБЛ.",
    "Almaty (city)": "Г. АЛМАТЫ",
    "Atyrau": "АТЫРАУСКАЯ ОБЛ.",
    "East Kazakhstan": "ВКО",
    "Jambyl": "ЖАМБЫЛСКАЯ ОБЛ.",
    "Jetisu": "ЖЕТЫСУСКАЯ ОБЛ.",
    "West Kazakhstan": "ЗКО",
    "Karaganda": "КАРАГАНДИНСКАЯ ОБЛ.",
    "Kostanay": "КОСТАНАЙСКАЯ ОБЛ.",
    "Kyzylorda": "КЫЗЫЛОРДИНСКАЯ ОБЛ.",
    "Mangystau": "МАНГИСТАУСКАЯ ОБЛ.",
    "Pavlodar": "ПАВЛОДАРСКАЯ ОБЛ.",
    "North Kazakhstan": "СКО",
    "Turkistan": "ТУРКЕСТАНСКАЯ ОБЛ.",
    "Ulytau": "УЛЫТАУСКАЯ ОБЛ.",
    "Astana": "Г. АСТАНА",
    "Shymkent (city)": "Г. ШЫМКЕНТ"
  };

  fetch("https://raw.githubusercontent.com/abzal4/KZ_GEOJSON/refs/heads/main/kz.json")
    .then(res => res.json())
    .then(geojsonData => {
      L.geoJSON(geojsonData, {
        style: () => ({
          color: "#555", weight: 1, fillOpacity: 0.07
        }),
        onEachFeature: (feature, layer) => {
          const regionEn = feature.properties.name;
          const regionRu = regionNameMap[regionEn] || regionEn;

          layer.bindTooltip(regionRu, { direction: "center" });

          layer.on("mouseover", () => {
            layer.setStyle({ weight: 3, color: "#0066cc", fillOpacity: 0.2 });
          });
          layer.on("mouseout", () => {
            layer.setStyle({ weight: 1, color: "#555", fillOpacity: 0.07 });
          });

          layer.on("click", () => {
            map.fitBounds(layer.getBounds());

            fetch("http://localhost:3000/cities")
              .then(res => res.json())
              .then(cities => {
                const filtered = cities.filter(c =>
                  (c.region_kato || "").toUpperCase() === regionRu.toUpperCase()
                );
                const total = filtered.length;
                const connected = filtered.filter(c => c.connected_to_exdbo === 1).length;

                document.getElementById("region-info").innerHTML = `
                  <b>${regionRu}</b><br>
                  Всего организаций: <b>${total}</b><br>
                  Подключено к ЕХД БО: <b>${connected}</b>
                `;

                showMarkersForCities(filtered);
              });
          });
        }
      }).addTo(map);
    });

  function generateColorPalette(n) {
    const saturation = 65, lightness = 55;
    return Array.from({ length: n }, (_, i) =>
      `hsl(${Math.floor(360 / n * i)}, ${saturation}%, ${lightness}%)`
    ).sort(() => Math.random() - 0.5);
  }

  const palette = generateColorPalette(211);
  const colors = {};
  let nextColorIndex = 0;

  function getColor(attendant) {
    if (!(attendant in colors)) {
      colors[attendant] = palette[nextColorIndex % palette.length];
      nextColorIndex++;
    }
    return colors[attendant];
  }

  const allMarkers = [];

  function showMarkersForCities(cities, forcedColor = null) {
    allMarkers.forEach(m => map.removeLayer(m));
    allMarkers.length = 0;

    for (const city of cities) {
      const color = forcedColor || getColor(city.attendant);
      const marker = L.circleMarker([city.lat, city.lon], {
        radius: 5, fillColor: color, color: "#fff", weight: 1, fillOpacity: 0.9
      }).addTo(map)
        .bindTooltip(`<b>${city.org_name}</b><br>${city.attendant}<br>${city.address}`, { direction: 'top' });

      marker.on("click", () => map.setView([city.lat, city.lon], 12));
      allMarkers.push(marker);
    }
  }

  function createSubitem(city, color) {
    const div = document.createElement("div");
    div.className = "subitem";
    div.style.color = color;
    div.innerHTML = `
      • <b>${city.org_name}</b><br>
      <span style="font-size:12px;color:#444">${city.address}</span><br>
      <span style="font-size:12px;color:#666">БИН: ${city.bin || "не указан"}</span><br>
      <span style="font-size:12px;color:#666">Подключено к ЕХД БО: ${city.connected_to_exdbo === 1 ? "да" : "нет"}</span>`;
    div.addEventListener("click", () => map.setView([city.lat, city.lon], 14));
    return div;
  }

  fetch("http://localhost:3000/cities")
    .then(res => res.json())
    .then(data => {
      const tableContainer = document.querySelector(".table-container");
      const toggleButton = document.getElementById("toggle-table");
      const tableBody = document.getElementById("table-body");

      toggleButton.addEventListener("click", () => {
        tableContainer.classList.toggle("collapsed");
        toggleButton.textContent = tableContainer.classList.contains("collapsed") ? "Развернуть таблицу" : "Свернуть таблицу";
      });

      const groups = {};
      data.forEach(city => {
        const att = city.attendant || "Не указано";
        if (!groups[att]) groups[att] = [];
        groups[att].push(city);
      });

      for (const att of Object.keys(groups).sort((a, b) => groups[b].length - groups[a].length)) {
        const row = document.createElement("tr");

        const attCell = document.createElement("td");
        attCell.textContent = att;
        attCell.style.color = getColor(att);
        attCell.style.fontWeight = "bold";

        const countCell = document.createElement("td");
        countCell.textContent = groups[att].length;

        const connectedCount = groups[att].reduce((sum, c) => sum + (c.connected_to_exdbo === 1 ? 1 : 0), 0);
        const connectedCell = document.createElement("td");
        connectedCell.textContent = connectedCount;
        connectedCell.style.fontWeight = "bold";
        connectedCell.style.color = "#444";

        row.append(attCell, countCell, connectedCell);
        tableBody.appendChild(row);

        const subRow = document.createElement("tr");
        const subCell = document.createElement("td");
        subCell.colSpan = 3;
        subCell.className = "subcell";
        subRow.appendChild(subCell);
        tableBody.appendChild(subRow);

        for (const city of groups[att]) {
          subCell.appendChild(createSubitem(city, getColor(att)));
        }

        row.addEventListener("click", () => {
          const isVisible = subCell.style.display !== "none";
          document.querySelectorAll(".subcell").forEach(cell => cell.style.display = "none");
          if (isVisible) {
            showMarkersForCities(data);
          } else {
            subCell.style.display = "table-cell";
            showMarkersForCities(groups[att], getColor(att));
          }
        });
      }

      showMarkersForCities(data);

      document.getElementById("search-input").addEventListener("input", function () {
        const query = this.value.trim().toLowerCase();
        tableContainer.classList.remove("collapsed");
        toggleButton.textContent = "Свернуть таблицу";

        const rows = document.querySelectorAll("#table-body > tr");
        const filteredCities = [];

        for (let i = 0; i < rows.length; i += 2) {
          const mainRow = rows[i];
          const subRow = rows[i + 1];
          const subCell = subRow.querySelector(".subcell");
          const attendant = mainRow.children[0].textContent.toLowerCase();
          const subitems = subCell.querySelectorAll(".subitem");

          let matchFound = false;
          const matchedCities = [];

          subitems.forEach((item, index) => {
            const text = item.innerText.toLowerCase();
            const isMatch = attendant.includes(query) || text.includes(query);
            item.style.display = isMatch ? "" : "none";
            if (isMatch) {
              matchFound = true;
              matchedCities.push(groups[mainRow.children[0].textContent][index]);
            }
          });

          mainRow.style.display = matchFound ? "" : "none";
          subRow.style.display = matchFound ? "" : "none";

          if (matchFound) filteredCities.push(...matchedCities);
        }

        showMarkersForCities(query === "" ? data : filteredCities);
      });

      document.getElementById("reset-view").addEventListener("click", () => {
        document.getElementById("search-input").value = "";
        document.querySelectorAll("#table-body > tr").forEach((row, i) => {
          row.style.display = i % 2 === 1 ? "none" : "";
        });
        document.getElementById("region-info").textContent = "Нажмите на регион для просмотра статистики";
        showMarkersForCities(data);
      });
    });
</script>

</body>
</html>
